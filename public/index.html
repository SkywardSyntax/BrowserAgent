<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Agent - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .task-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .task-status {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-created { background: #dbeafe; color: #1e40af; }
        .status-running { background: #dcfce7; color: #166534; }
        .status-paused { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-stopped { background: #f3f4f6; color: #374151; }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .step {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
        }
        
        .step.error {
            background: rgba(220, 38, 38, 0.2);
        }
        
        .step.reasoning {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        Connecting...
    </div>

    <div class="container">
        <div class="header">
            <h1>ðŸ¤– Browser Agent</h1>
            <p>AI-powered browser automation for completing web tasks</p>
        </div>

        <div class="task-form">
            <h2>Create New Task</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskDescription">Task Description</label>
                    <textarea 
                        id="taskDescription" 
                        placeholder="Describe what you want the AI to do in the browser, e.g., 'Search for JavaScript tutorials on YouTube' or 'Fill out the contact form on example.com'"
                        required
                    ></textarea>
                </div>
                <button type="submit" class="btn" id="submitBtn">Start Task</button>
            </form>
        </div>

        <div class="task-status hidden" id="taskStatus">
            <h2>Current Task</h2>
            <div id="taskInfo">
                <p><strong>Description:</strong> <span id="taskDesc"></span></p>
                <p><strong>Status:</strong> <span id="status" class="status-badge"></span></p>
                <p><strong>Created:</strong> <span id="createdAt"></span></p>
            </div>
            
            <div class="controls">
                <button class="btn btn-secondary" id="pauseBtn">Pause</button>
                <button class="btn" id="resumeBtn">Resume</button>
                <button class="btn btn-danger" id="stopBtn">Stop</button>
            </div>
            
            <h3 style="margin-top: 30px;">Activity Log</h3>
            <div class="log" id="activityLog"></div>
        </div>
    </div>

    <script>
        class BrowserAgentUI {
            constructor() {
                this.ws = null;
                this.currentTaskId = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                this.initElements();
                this.initEventListeners();
                this.connect();
            }
            
            initElements() {
                this.taskForm = document.getElementById('taskForm');
                this.taskDescription = document.getElementById('taskDescription');
                this.submitBtn = document.getElementById('submitBtn');
                this.taskStatus = document.getElementById('taskStatus');
                this.taskDesc = document.getElementById('taskDesc');
                this.status = document.getElementById('status');
                this.createdAt = document.getElementById('createdAt');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resumeBtn = document.getElementById('resumeBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.activityLog = document.getElementById('activityLog');
                this.connectionStatus = document.getElementById('connectionStatus');
            }
            
            initEventListeners() {
                this.taskForm.addEventListener('submit', (e) => this.handleTaskSubmit(e));
                this.pauseBtn.addEventListener('click', () => this.pauseTask());
                this.resumeBtn.addEventListener('click', () => this.resumeTask());
                this.stopBtn.addEventListener('click', () => this.stopTask());
            }
            
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.updateConnectionStatus(false);
                    this.scheduleReconnect();
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus(false);
                };
            }
            
            scheduleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    setTimeout(() => {
                        console.log(`Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                        this.connect();
                    }, 2000 * this.reconnectAttempts);
                }
            }
            
            updateConnectionStatus(connected) {
                this.connectionStatus.textContent = connected ? 'Connected' : 'Disconnected';
                this.connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'taskUpdate':
                        this.updateTaskDisplay(data.task);
                        break;
                }
            }
            
            async handleTaskSubmit(e) {
                e.preventDefault();
                
                const task = this.taskDescription.value.trim();
                if (!task) return;
                
                this.submitBtn.disabled = true;
                this.submitBtn.textContent = 'Creating...';
                
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.currentTaskId = result.taskId;
                        this.taskDescription.value = '';
                        this.taskStatus.classList.remove('hidden');
                        
                        // Subscribe to task updates
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'subscribe',
                                taskId: this.currentTaskId
                            }));
                        }
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    this.submitBtn.disabled = false;
                    this.submitBtn.textContent = 'Start Task';
                }
            }
            
            async pauseTask() {
                if (!this.currentTaskId) return;
                await this.taskAction('pause');
            }
            
            async resumeTask() {
                if (!this.currentTaskId) return;
                await this.taskAction('resume');
            }
            
            async stopTask() {
                if (!this.currentTaskId) return;
                await this.taskAction('stop');
            }
            
            async taskAction(action) {
                try {
                    const response = await fetch(`/api/tasks/${this.currentTaskId}/${action}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const result = await response.json();
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
            
            updateTaskDisplay(task) {
                this.taskDesc.textContent = task.description;
                this.status.textContent = task.status;
                this.status.className = `status-badge status-${task.status}`;
                this.createdAt.textContent = new Date(task.createdAt).toLocaleString();
                
                // Update button states
                this.pauseBtn.disabled = task.status !== 'running';
                this.resumeBtn.disabled = task.status !== 'paused';
                this.stopBtn.disabled = ['completed', 'failed', 'stopped'].includes(task.status);
                
                // Update activity log
                this.updateActivityLog(task.steps || []);
            }
            
            updateActivityLog(steps) {
                this.activityLog.innerHTML = '';
                
                steps.forEach(step => {
                    const div = document.createElement('div');
                    div.className = `step ${step.error ? 'error' : ''} ${step.reasoning ? 'reasoning' : ''}`;
                    div.innerHTML = `
                        <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">
                            ${new Date(step.timestamp).toLocaleTimeString()}
                        </div>
                        <div>${step.description}</div>
                    `;
                    this.activityLog.appendChild(div);
                });
                
                // Scroll to bottom
                this.activityLog.scrollTop = this.activityLog.scrollHeight;
            }
        }
        
        // Initialize the UI when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BrowserAgentUI();
        });
    </script>
</body>
</html>